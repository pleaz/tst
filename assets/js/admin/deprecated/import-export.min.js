var wpghImportExport;!function($){wpghImportExport={completedRows:0,skippedRows:0,allRows:0,status:null,results:null,import_id:null,tags:null,size:100,contactsToDelete:0,deletedContacts:0,init:function(){$(".import").on("click",function(){wpghImportExport.load()}),$(".export").on("click",function(){wpghImportExport.export("wpgh_export_contacts")}),$(".query-export").on("click",function(){wpghImportExport.export("wpgh_query_export_contacts")}),$(".bulk-delete").on("click",function(){wpghImportExport.bulkDelete()}),this.status=$(".import-status"),console.log("Importer Ready")},load:function(){$("input[type=file]").parse({config:{download:!0,delimiter:",",header:!0,complete:function(t,e){wpghImportExport.allRows=t.data.length,wpghImportExport.results=t.data,wpghImportExport.completedRows=0,wpghImportExport.skippedRows=0}},complete:function(){wpghImportExport.tags=$("#import_tags").val(),wpghImportExport.import_id=wpghImportExport.guidGenerator(),wpghImportExport.import()}})},import:function(){$(".spinner-import").css("visibility","visible");var t=this.size;this.results.length<this.size&&(t=this.results.length);for(var e=this.results.splice(0,t),o=0;o<e.length;o++)this.clean(e[o]);this.send(e)},clean:function(t){for(var e=Object.getOwnPropertyNames(t),o=0;o<e.length;o++){var s=e[o];null!==t[s]&&void 0!==t[s]&&""!==t[s]||delete t[s]}},send:function(t){$.ajax({type:"post",url:ajaxurl,dataType:"json",data:{action:"wpgh_import_contacts",data:t,tags:this.tags,import_id:this.import_id},success:function(t){void 0!==t.completed?(wpghImportExport.completedRows+=t.completed,wpghImportExport.skippedRows+=t.skipped,wpghImportExport.updateStatus(),wpghImportExport.results.length>0&&wpghImportExport.import()):(console.log(t),alert(t),$(".spinner-import").css("visibility","hidden"))},error:function(t){console.log(t),alert(t),$(".spinner-import").css("visibility","hidden")}})},updateStatus:function(){var t=Math.ceil((this.completedRows+this.skippedRows)/this.allRows*100);($("#import-loader-wrap").removeClass("hidden"),$("#import-loader").animate({width:t+"%"},"slow"),$("#import-loader-percentage").text(t+"%"),this.status.html("Status: "+t+"% | Completed: "+this.completedRows+" | Skipped: "+this.skippedRows),console.log({status:t,completed:this.completedRows,skipped:this.skippedRows}),t>=100)&&$(".spinner-import").css("visibility","hidden")},export:function(t){var e=$("#export_tags").val();this.retrieve(t,e)},retrieve:function(t,e){var o=$(".spinner-export");o.css("visibility","visible"),$.ajax({type:"post",url:ajaxurl,dataType:"json",data:{action:t,tags:e},success:function(t){o.css("visibility","hidden");var e=Papa.unparse(t,{quotes:!1,quoteChar:'"',escapeChar:'"',delimiter:",",header:!0,newline:"\r\n"});wpghImportExport.makeFile(e)}})},makeFile:function(t){var e=document.createElement("a");e.setAttribute("href","data:text/csv;charset=utf-8,"+encodeURIComponent(t));var o=new Date,s=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()+" "+(o.getHours()+":"+o.getMinutes()+":"+o.getSeconds());e.setAttribute("download","contacts-"+s+".csv"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)},bulkDelete:function(){var t=$("#delete_tags").val(),e=$(".spinner-delete");e.css("visibility","visible"),$.ajax({type:"post",url:ajaxurl,data:{action:"wpgh_bulk_delete_contacts",tags:t},dataType:"json",success:function(t){if(console.log(t),void 0!==t.complete)$("#delete_tags").val("").change(),e.css("visibility","hidden"),$("#delete-loader-percentage").text(t.message);else{wpghImportExport.deletedContacts+=t.contactsDeleted;var o=Math.round(wpghImportExport.deletedContacts/parseInt(t.totalContacts)*100);$("#delete-loader-wrap").removeClass("hidden"),$("#delete-loader").animate({width:o+"%"},"slow"),$("#delete-loader-percentage").text(o+"%"),wpghImportExport.bulkDelete()}}})},guidGenerator:function(){var t=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}},$(function(){wpghImportExport.init()})}(jQuery);