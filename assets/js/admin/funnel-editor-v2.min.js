!function($,t,e,n){$.extend(t,{sortables:null,reportData:null,getSteps:function(){return $("#step-sortable")},getSettings:function(){return $(".step-settings")},init:function(){var t=this,e=$(document),n=$("#funnel-form"),a=t.getSteps();t.getSettings();e.on("change input",".step-title-large",function(){var t=$(this),e=t.attr("data-id");$("#"+e).find(".step-title").text(t.val())}),e.on("click","#postbox-container-1 .step",function(e){t.makeActive(this.id)}),e.on("click","td.step-icon",function(e){var n=a.find(".active");$('<div class="replace-me"></div>').insertAfter(n);var i=$(this).find(".wpgh-element").attr("id"),s=(a.index(n),{action:"wpgh_get_step_html",step_type:i,after_step:n.attr("id"),funnel_id:t.id,version:2});t.getStepHtml(s)}),e.on("click","button.delete-step",function(e){t.deleteStep(this.parentNode.parentNode.id)}),e.on("click","button.duplicate-step",function(e){t.duplicateStep(this.parentNode.parentNode.id)}),n.on("submit",function(e){e.preventDefault(),t.save(n)}),e.on("change",".auto-save",function(e){e.preventDefault(),t.save($("#funnel-form"))}),e.on("click","#enter-full-screen",function(t){$("html").toggleClass("full-screen")}),window.innerWidth>600&&this.makeSortable(),this.initReporting(),$("#add-contacts-button").click(function(){t.addContacts()}),$("#copy-share-link").click(function(t){t.preventDefault(),prompt("Copy this link.",$("#share-link").val())})},initReporting:function(){$("#reporting-toggle").on("input",function(){$(this).is(":checked")?$("html").addClass("reporting-enabled"):$("html").removeClass("reporting-enabled")}),$("#custom_date_range_start").datepicker({changeMonth:!0,changeYear:!0,maxDate:0,dateFormat:"d-m-yy"}),$("#custom_date_range_end").datepicker({changeMonth:!0,changeYear:!0,maxDate:0,dateFormat:"d-m-yy"}),$("#date_range").change(function(){"custom"===$(this).val()?($("#custom_date_range_end").removeClass("hidden"),$("#custom_date_range_start").removeClass("hidden")):($("#custom_date_range_end").addClass("hidden"),$("#custom_date_range_start").addClass("hidden"))})},save:function(t){var e=this;showSpinner();var a=t.serialize();a+="&action=gh_save_funnel_via_ajax&version=2",adminAjaxRequest(a,function(t){handleNotices(t.data.notices),hideSpinner(),e.getSettings().html(t.data.data.settings),e.getSteps().html(t.data.data.sortable),console.log(t),n.data=t.data.data.chartData,$("#funnel-chart").hasClass("hidden")||n.draw(),$(document).trigger("new-step")})},makeSortable:function(){this.sortables=$(".ui-sortable").sortable({placeholder:"sortable-placeholder",connectWith:".ui-sortable",axis:"y",start:function(t,e){e.helper.css("left",(e.item.parent().width()-e.item.width())/2),e.placeholder.height(e.item.height()),e.placeholder.width(e.item.width())}}),this.sortables.disableSelection()},deleteStep:function(t){showSpinner();var e=$("#"+t);confirm("Are you sure you want to delete this step? Any contacts currently waiting will be moved to the next action.")?adminAjaxRequest({action:"wpgh_delete_funnel_step",step_id:t},function(n){hideSpinner(),e.remove(),$("#settings-"+t).remove()}):hideSpinner()},duplicateStep:function(t){var e=$("#"+t);$('<div class="replace-me"></div>').insertAfter(e);var n={action:"wpgh_duplicate_funnel_step",step_id:t,version:2};this.getStepHtml(n)},getStepHtml:function(t){var n=this,a=n.getSteps(),i=n.getSettings();showSpinner(),adminAjaxRequest(t,function(t){var s=a.find(".replace-me");s.length>0?s.replaceWith(t.data.data.sortable):a.append(t.data.data.sortable),i.append(t.data.data.settings),n.makeActive(t.data.data.id),e.close(),hideSpinner(),$(document).trigger("new-step")})},makeActive:function(t){var e=this.getSteps(),n=this.getSettings(),a=$("html"),i=$("#"+t),s=i.hasClass("active");if(n.find(".step").addClass("hidden"),n.find(".step").removeClass("active"),e.find(".step").removeClass("active"),e.find(".is_active").val(null),a.removeClass("active-step"),!s){i.addClass("active"),i.find(".is_active").val(1);var d="#settings-"+i.attr("id"),o=$(d);o.removeClass("hidden"),o.addClass("active"),a.addClass("active-step"),$(document).trigger("step-active")}}}),$(function(){t.init()})}(jQuery,Funnel,GroundhoggModal,FunnelChart);