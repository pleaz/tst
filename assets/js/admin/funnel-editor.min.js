!function($,e){$.extend(e,{editorID:"#normal-sortables",editor:null,sortables:null,draggables:null,curStep:null,curHTML:null,curOrder:0,reportData:null,sidebar:null,init:function(){var e=this;this.editor=$(this.editorID),this.editor.on("click","button.delete-step",function(t){e.deleteStep(this)}),this.editor.on("click","button.duplicate-step",function(t){e.duplicateStep(this)}),$("#funnel-form").on("submit",function(t){t.preventDefault(),e.save($(this))}),$(document).on("change",".auto-save",function(t){t.preventDefault(),e.save($("#funnel-form"))}),$(document).on("GroundhoggModalClosed",function(t){t.preventDefault(),e.save($("#funnel-form"))}),$(document).on("GroundhoggModalClosed",function(t){t.preventDefault(),e.save($("#funnel-form"))}),$(document).on("click","#enter-full-screen",function(t){$("html").toggleClass("full-screen"),e.editorSizing()}),window.innerWidth>600&&(this.makeSortable(),this.makeDraggable()),this.initReporting(),this.editorSizing(),$(window).resize(function(){e.editorSizing()}),$("#add-contacts-button").click(function(){e.addContacts()}),$("#copy-share-link").click(function(e){e.preventDefault(),prompt("Copy this link.",$("#share-link").val())}),$(document).on("click",".postbox .collapse",function(t){var n=$(this.parentNode);n.hasClass("closed")?e.expandStep(n):e.collapseStep(n)}),$("#postbox-container-1 .hndle").click(function(t){$(this.parentNode).toggleClass("closed"),e.sidebar.updateSticky()})},editorSizing:function(){$(".funnel-editor-header").width($("#poststuff").width()),$("#postbox-container-2").height($("#wpbody").height()-80),this.sidebar=new StickySidebar("#postbox-container-1",{topSpacing:$("html").hasClass("full-screen")?47:78,bottomSpacing:0}),$("#normal-sortables").css("visibility","visible")},initReporting:function(){var e=$("#reporting-toggle");e.on("input",function(){$(this).is(":checked")?($(".step-reporting").removeClass("hidden"),$(".step-edit").addClass("hidden"),$("html").addClass("reporting-enabled")):($(".step-reporting").addClass("hidden"),$(".step-edit").removeClass("hidden"),$("html").removeClass("reporting-enabled"))}),e.is(":checked")&&($(".step-reporting").removeClass("hidden"),$(".step-reporting").removeClass("hidden"),$(".step-edit").addClass("hidden")),$("#custom_date_range_start").datepicker({changeMonth:!0,changeYear:!0,maxDate:0,dateFormat:"d-m-yy"}),$("#custom_date_range_end").datepicker({changeMonth:!0,changeYear:!0,maxDate:0,dateFormat:"d-m-yy"}),$("#date_range").change(function(){"custom"===$(this).val()?($("#custom_date_range_end").removeClass("hidden"),$("#custom_date_range_start").removeClass("hidden")):($("#custom_date_range_end").addClass("hidden"),$("#custom_date_range_start").addClass("hidden"))})},save:function(e){showSpinner();var t=e.serialize();t+="&action=gh_save_funnel_via_ajax",adminAjaxRequest(t,function(e){handleNotices(e.data.notices),hideSpinner(),$("#normal-sortables").html(e.data.data.steps),FunnelChart.data=e.data.data.chartData,$("#funnel-chart").hasClass("hidden")||FunnelChart.draw(),$(document).trigger("new-step")})},insertDummyStep:function(e){return this.editor.find(e).length>0&&(this.editor.find(e).replaceWith('<div id="temp-step" class="postbox step replace-me" style="width: 500px;margin-right: auto;margin-left: auto;"><h3 class="hndle">Please Wait...</h3><div class="inside">Loading content...</div></div>'),!0)},replaceDummyStep:function(e){this.editor.find(".replace-me").replaceWith(e),$(document).trigger("new-step")},convertDraggableToStep:function(t){var n=t.id;if(this.insertDummyStep(".ui-draggable")){var a={action:"wpgh_get_step_html",step_type:n,step_order:$(".step").index($("#temp-step"))+1,funnel_id:e.id,version:1};this.getStepHtml(a)}},makeDraggable:function(){var e=this;this.draggables=$(".ui-draggable").draggable({connectToSortable:".ui-sortable",helper:"clone",stop:function(t,n){n.helper.closest("#normal-sortables").length>0&&(console.log(n.helper.parent()),e.convertDraggableToStep(this))}})},makeSortable:function(){this.sortables=$(".ui-sortable").sortable({placeholder:"sortable-placeholder",connectWith:".ui-sortable",axis:"y",start:function(e,t){t.helper.css("left",(t.item.parent().width()-t.item.width())/2),t.placeholder.height(t.item.height()),t.placeholder.width(t.item.width())}}),this.sortables.disableSelection()},deleteStep:function(e){showSpinner();var t=$(e).closest(".step");confirm("Are you sure you want to delete this step? Any contacts currently waiting will be moved to the next action.")?adminAjaxRequest({action:"wpgh_delete_funnel_step",step_id:t.attr("id")},function(e){hideSpinner(),t.remove()}):hideSpinner()},duplicateStep:function(e){var t=$(e).closest(".step");$('<div class="replace-me"></div>').insertAfter(t),this.insertDummyStep(".replace-me");var n={action:"wpgh_duplicate_funnel_step",step_id:t.attr("id"),version:1};this.getStepHtml(n)},getStepHtml:function(e){var t=this;adminAjaxRequest(e,function(e){t.curHTML=e.data.data.html,t.replaceDummyStep(t.curHTML)})},addContacts:function(){var e=$("#add_contacts_to_funnel_tag_picker").val();if(e){var t=$("#add_contacts_to_funnel_step_picker").val();t?(showSpinner(),adminAjaxRequest({action:"gh_add_contacts_to_funnel",tags:e,step:t},function(e){hideSpinner()})):alert("Please select at funnel step.")}else alert("Please select at least 1 tag.")},collapseStep:function(e){console.log(e),e.addClass("closed"),e.find(".collapse-input").val("1")},expandStep:function(e){e.removeClass("closed"),e.find(".collapse-input").val("")}}),$(function(){e.init()})}(jQuery,Funnel);